{% extends "base.html" %}
{% block title %}–°—Ü–µ–Ω–∞—Ä–∏–π {{ turn }} - –ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –°–∏–º—É–ª—è—Ç–æ—Ä{% endblock %}
{% block content %}
<div style="max-width: 800px; margin: 0 auto; padding: 20px;">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Ç—Ä–∞–Ω—ã -->
    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 30px;">
        <div style="background: white; border-radius: 8px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid #27ae60;">
            <div style="font-size: 12px; color: #666;">–≠–∫–æ–Ω–æ–º–∏–∫–∞</div>
            <div id="economy-value" style="font-size: 24px; font-weight: bold; color: #27ae60;">{{ stats.economy }}</div>
        </div>
        <div style="background: white; border-radius: 8px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid #3498db;">
            <div style="font-size: 12px; color: #666;">–°–æ—Ü–∏—É–º</div>
            <div id="social-value" style="font-size: 24px; font-weight: bold; color: #3498db;">{{ stats.social }}</div>
        </div>
        <div style="background: white; border-radius: 8px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid #2ecc71;">
            <div style="font-size: 12px; color: #666;">–≠–∫–æ–ª–æ–≥–∏—è</div>
            <div id="environment-value" style="font-size: 24px; font-weight: bold; color: #2ecc71;">{{ stats.environment }}</div>
        </div>
        <div style="background: white; border-radius: 8px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid #9b59b6;">
            <div style="font-size: 12px; color: #666;">–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å</div>
            <div id="popularity-value" style="font-size: 24px; font-weight: bold; color: #9b59b6;">{{ stats.popularity }}</div>
        </div>
        <div style="background: white; border-radius: 8px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid #e74c3c;">
            <div style="font-size: 12px; color: #666;">–ë—é–¥–∂–µ—Ç</div>
            <div id="budget-value" style="font-size: 24px; font-weight: bold; color: #e74c3c;">{{ stats.budget }}</div>
        </div>
    </div>

    <!-- –•–æ–¥ –∏–≥—Ä—ã -->
    <div style="background: #2c3e50; color: white; padding: 10px 20px; border-radius: 5px; display: inline-block; margin-bottom: 10px;">
        –•–æ–¥ {{ turn }} –∏–∑ 5
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
    <div style="margin-bottom: 20px;">
        <div style="height: 10px; background: #ecf0f1; border-radius: 5px; overflow: hidden;">
            <div id="progress-bar" style="height: 100%; width: {{ (turn / 5 * 100) }}%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 5px; transition: width 0.5s;"></div>
        </div>
    </div>

    <!-- –°—Ü–µ–Ω–∞—Ä–∏–π -->
    <div class="card" style="margin-bottom: 30px;">
        <h2 style="color: #2c3e50; margin-bottom: 15px;">{{ scenario.title }}</h2>
        <p style="font-size: 18px; line-height: 1.6; color: #333; margin-bottom: 25px;">
            {{ scenario.description }}
        </p>

        <h3 style="color: #2c3e50; margin-bottom: 20px;">–í–∞—à–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã:</h3>

        <div id="options-container">
            {% for option in scenario.options %}
            <div class="option-card" data-scenario-id="{{ scenario.id }}" data-option-index="{{ loop.index0 }}"
                 style="background: white; border: 2px solid #eee; border-radius: 8px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: #2c3e50;">{{ option.text }}</h4>
                    <div style="font-size: 12px; color: #666; background: #f8f9fa; padding: 4px 10px; border-radius: 12px;">
                        {{ option.description }}
                    </div>
                </div>

                <div style="display: flex; gap: 15px; font-size: 14px;">
                    {% for stat, value in option.effects.items() %}
                    <div style="color: {% if value > 0 %}#27ae60{% elif value < 0 %}#e74c3c{% else %}#7f8c8d{% endif %};">
                        {% if value > 0 %}+{% endif %}{{ value }}
                        {% if stat == 'economy' %}–≠–∫–æ–Ω–æ–º–∏–∫–∞
                        {% elif stat == 'social' %}–°–æ—Ü–∏—É–º
                        {% elif stat == 'environment' %}–≠–∫–æ–ª–æ–≥–∏—è
                        {% elif stat == 'popularity' %}–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å
                        {% else %}–ë—é–¥–∂–µ—Ç{% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="result" style="margin-bottom: 20px;"></div>
    <div id="loading" style="display: none; text-align: center; margin: 20px 0;">
        <div style="display: inline-block; padding: 15px 30px; background: #2c3e50; color: white; border-radius: 8px;">
            <i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...
        </div>
    </div>

    <div style="text-align: center;">
        <a href="/dashboard" class="btn" style="background: #95a5a6; color: white; padding: 12px 24px; border-radius: 5px; text-decoration: none; margin-right: 15px;">
            <i class="fas fa-home"></i> –í –ö–∞–±–∏–Ω–µ—Ç
        </a>
    </div>
</div>

<style>
    .card {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .option-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-color: #3498db;
    }

    .btn {
        display: inline-block;
        padding: 12px 24px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        border: none;
        cursor: pointer;
        transition: background 0.3s;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const optionCards = document.querySelectorAll('.option-card');
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');
        const progressBar = document.getElementById('progress-bar');

        optionCards.forEach(card => {
            card.addEventListener('click', function() {
                const scenarioId = this.dataset.scenarioId;
                const optionIndex = this.dataset.optionIndex;

                // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
                optionCards.forEach(c => {
                    c.style.pointerEvents = 'none';
                    c.style.opacity = '0.6';
                    c.style.cursor = 'not-allowed';
                });

                // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                this.style.borderColor = '#3498db';
                this.style.background = '#f8fafc';

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                resultDiv.innerHTML = '<div style="background: #cce5ff; color: #004085; padding: 15px; border-radius: 5px; text-align: center;"><i class="fas fa-spinner fa-spin"></i> –ü—Ä–∏–Ω–∏–º–∞–µ–º —Ä–µ—à–µ–Ω–∏–µ...</div>';

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                fetch('/make_decision', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        scenario_id: parseInt(scenarioId),
                        option_index: parseInt(optionIndex)
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);

                    if (data.success) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        document.getElementById('economy-value').textContent = data.stats.economy;
                        document.getElementById('social-value').textContent = data.stats.social;
                        document.getElementById('environment-value').textContent = data.stats.environment;
                        document.getElementById('popularity-value').textContent = data.stats.popularity;
                        document.getElementById('budget-value').textContent = data.stats.budget;

                        // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
                        animateValueChange('economy-value', data.stats.economy);
                        animateValueChange('social-value', data.stats.social);
                        animateValueChange('environment-value', data.stats.environment);
                        animateValueChange('popularity-value', data.stats.popularity);
                        animateValueChange('budget-value', data.stats.budget);

                        if (data.game_completed) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                            progressBar.style.width = '100%';

                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
                            resultDiv.innerHTML = '<div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; text-align: center;">üéâ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°—á–∏—Ç–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...</div>';
                            loadingDiv.style.display = 'block';

                            // –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º
                            setTimeout(() => {
                                window.location.href = '/game_result';
                            }, 2000);
                        } else {
                            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                            const currentTurn = parseInt("{{ turn }}") + 1;
                            const newWidth = (currentTurn / 5) * 100;
                            progressBar.style.width = newWidth + '%';

                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                            resultDiv.innerHTML = '<div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; text-align: center;">‚úÖ –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ö–æ–¥—É...</div>';

                            // –ñ–¥–µ–º 1.5 —Å–µ–∫—É–Ω–¥—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        }
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                        resultDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; text-align: center;">
                            ‚ùå –û—à–∏–±–∫–∞: ${data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                        </div>`;

                        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                        resetOptionCards();
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                    resultDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; text-align: center;">
                        ‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}.<br>
                        –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.
                    </div>`;

                    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                    resetOptionCards();
                });
            });
        });

        function animateValueChange(elementId, newValue) {
            const element = document.getElementById(elementId);
            const currentValue = parseInt(element.textContent);
            const diff = newValue - currentValue;

            if (diff !== 0) {
                // –í—Ä–µ–º–µ–Ω–Ω–æ –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç
                const originalColor = element.style.color;
                element.style.color = diff > 0 ? '#27ae60' : '#e74c3c';

                // –ü—É–ª—å—Å–∏—Ä—É—é—â–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
                element.style.animation = 'pulse 0.5s ease-in-out';

                setTimeout(() => {
                    element.style.color = originalColor;
                    element.style.animation = '';
                }, 1000);
            }
        }

        function resetOptionCards() {
            optionCards.forEach(c => {
                c.style.pointerEvents = 'auto';
                c.style.opacity = '1';
                c.style.cursor = 'pointer';
                c.style.background = 'white';
                c.style.borderColor = '#eee';
            });
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—É–ª—å—Å–∞—Ü–∏–∏
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }

            .option-card {
                transition: all 0.3s ease;
            }

            .option-card:active {
                transform: scale(0.98);
            }
        `;
        document.head.appendChild(style);
    });
</script>
{% endblock %}